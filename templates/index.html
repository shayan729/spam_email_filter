<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spam Email Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .stage-card { transition: all 0.3s ease-in-out; border-left-width: 4px; }
        .stage-pending { border-color: #9ca3af; }
        .stage-passed { border-color: #22c55e; background-color: #f0fdf4; }
        .stage-failed { border-color: #ef4444; background-color: #fef2f2; }
        .stage-skipped { border-color: #eab308; background-color: #fefce8; }
        .status-icon { font-size: 1.5rem; line-height: 1; }
        .file-input-label { cursor: pointer; border: 2px dashed #cbd5e1; padding: 2rem; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; }
        .file-input-label:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .extracted-item { word-break: break-all; }
        .vt-scan-btn { background-color: #e0f2fe; color: #0c4a6e; font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.6rem; border-radius: 9999px; transition: all 0.2s; }
        .vt-scan-btn:hover { background-color: #bae6fd; }
        .vt-scan-btn:disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
        #vt-modal { transition: opacity 0.3s ease-in-out; }
        #vt-modal-content-box { transition: transform 0.3s ease-in-out; }
        .pipeline-item.active { border-color: #3b82f6; background-color: #eff6ff; font-weight: 600; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold">Spam Email Analyzer</h1>
            <p class="mt-4 text-lg text-gray-600">A multi-stage tool to detect, analyze, and understand email threats.</p>
        </header>

        <main class="space-y-8">
            <!-- Informational Section -->
            <section class="bg-white p-6 md:p-8 rounded-xl shadow-sm">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">The Filtering Pipeline</h2>
                <p class="text-gray-600 mb-8">Our system uses a multi-stage process to analyze each email. Click any stage to learn more.</p>
                <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-4 text-center mb-8">
                    <div id="pipeline-1" class="pipeline-item cursor-pointer p-4 border-2 rounded-lg flex-1 w-full"><h3>1. Header Analysis</h3></div>
                    <div class="pipeline-arrow text-2xl font-light transform md:rotate-0 rotate-90">&rarr;</div>
                    <div id="pipeline-2" class="pipeline-item cursor-pointer p-4 border-2 rounded-lg flex-1 w-full"><h3>2. Content Analysis</h3></div>
                    <div class="pipeline-arrow text-2xl font-light transform md:rotate-0 rotate-90">&rarr;</div>
                    <div id="pipeline-3" class="pipeline-item cursor-pointer p-4 border-2 rounded-lg flex-1 w-full"><h3>3. Link & Attachment Scan</h3></div>
                    <div class="pipeline-arrow text-2xl font-light transform md:rotate-0 rotate-90">&rarr;</div>
                    <div id="pipeline-4" class="pipeline-item cursor-pointer p-4 border-2 rounded-lg flex-1 w-full"><h3>4. Machine Learning Model</h3></div>
                </div>
                <div class="bg-gray-50 p-6 rounded-lg min-h-[120px] transition-all">
                    <h3 id="pipeline-detail-title" class="text-lg font-bold text-blue-800"></h3>
                    <p id="pipeline-detail-text" class="mt-2 text-gray-700"></p>
                </div>
            </section>

            <!-- Analyzer Section -->
            <section class="bg-white p-6 md:p-8 rounded-xl shadow-sm">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Live Analyzer</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Option 1: Paste Raw Content</h3>
                        <textarea id="email-content" rows="12" class="w-full p-4 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Paste the full email source here..."></textarea>
                    </div>
                    <div class="flex flex-col h-full">
                         <h3 class="text-lg font-semibold mb-2">Option 2: Upload .eml File</h3>
                         <div class="flex-grow">
                             <label for="eml-file-input" class="file-input-label rounded-lg h-full">
                                 <svg class="w-12 h-12 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V6a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 16v-2a2 2 0 00-2-2H8a2 2 0 00-2 2v2m6-10v-2a2 2 0 00-2-2H8a2 2 0 00-2 2v2"></path></svg>
                                 <span class="font-semibold text-blue-600">Click to upload</span><span id="file-name-display" class="mt-2 text-sm font-medium"></span>
                            </label>
                            <input type="file" id="eml-file-input" class="hidden" accept=".eml">
                         </div>
                    </div>
                </div>
                <div class="mt-6 border-t pt-6"><button id="analyze-btn" class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 disabled:bg-gray-400">Analyze</button></div>
            </section>

            <!-- Results Section -->
            <section id="results-container" class="bg-white p-6 md:p-8 rounded-xl shadow-sm hidden">
                <h2 class="text-2xl font-bold mb-6">Analysis Results</h2>
                <div id="verdict-banner"></div>
                <div id="pipeline-stages" class="space-y-4"></div>
                <div class="mt-8 border-t pt-6 space-y-6">
                    <div id="links-section" class="hidden"><h3 class="text-xl font-semibold">Extracted Links</h3><ul id="links-list" class="space-y-3 mt-3"></ul></div>
                    <div id="attachments-section" class="hidden"><h3 class="text-xl font-semibold">Detected Attachments</h3><ul id="attachments-list" class="space-y-3 mt-3"></ul></div>
                </div>
            </section>
        </main>
    </div>

    <!-- VirusTotal Scan Result Modal -->
    <div id="vt-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div id="vt-modal-content-box" class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">VirusTotal Scan Result</h3>
                <button id="vt-modal-close-btn" class="text-2xl font-bold leading-none text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="vt-modal-content" class="text-sm"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const analyzeBtn = document.getElementById('analyze-btn'), emailContent = document.getElementById('email-content'),
              fileInput = document.getElementById('eml-file-input'), fileNameDisplay = document.getElementById('file-name-display'),
              resultsContainer = document.getElementById('results-container'), verdictBanner = document.getElementById('verdict-banner'),
              pipelineStages = document.getElementById('pipeline-stages'), linksSection = document.getElementById('links-section'),
              linksList = document.getElementById('links-list'), attachmentsSection = document.getElementById('attachments-section'),
              attachmentsList = document.getElementById('attachments-list'), vtModal = document.getElementById('vt-modal'),
              vtModalContentBox = document.getElementById('vt-modal-content-box'), vtModalContent = document.getElementById('vt-modal-content'),
              vtModalCloseBtn = document.getElementById('vt-modal-close-btn');

        let originalFileObject = null;

        // --- Static Pipeline Info Logic ---
        const pipelineContent = {
            'pipeline-1': { title: 'Stage 1: Header Analysis', text: 'Scrutinizes sender reputation, authentication records (SPF, DKIM), and routing information to detect forged identities.' },
            'pipeline-2': { title: 'Stage 2: Content Analysis', text: 'Scans the email body for spam keywords, suspicious phrases, and formatting tricks using Natural Language Processing (NLP).' },
            'pipeline-3': { title: 'Stage 3: Link & Attachment Scan', text: 'Checks all embedded links against a database of malicious URLs and scans attachments for malware and dangerous file types.' },
            'pipeline-4': { title: 'Stage 4: Machine Learning Model', text: 'Feeds all collected data into an SVM model, which calculates a final spam score based on thousands of features to make a final classification.' }
        };
        const pipelineItems = document.querySelectorAll('.pipeline-item');
        pipelineItems.forEach(item => {
            item.addEventListener('click', () => {
                pipelineItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                const content = pipelineContent[item.id];
                document.getElementById('pipeline-detail-title').textContent = content.title;
                document.getElementById('pipeline-detail-text').textContent = content.text;
            });
        });
        document.getElementById('pipeline-1').click(); // Set initial state

        // --- Event Listeners & Modal Controls ---
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                originalFileObject = fileInput.files[0];
                fileNameDisplay.textContent = originalFileObject.name;
                emailContent.value = '';
            }
        });
        emailContent.addEventListener('input', () => { if(emailContent.value) { originalFileObject = null; fileInput.value = ''; fileNameDisplay.textContent = ''; }});
        const openModal = () => { vtModal.classList.remove('hidden'); setTimeout(() => { vtModal.classList.remove('opacity-0'); vtModalContentBox.classList.remove('scale-95'); }, 10); };
        const closeModal = () => { vtModal.classList.add('opacity-0'); vtModalContentBox.classList.add('scale-95'); setTimeout(() => vtModal.classList.add('hidden'), 300); };
        vtModalCloseBtn.addEventListener('click', closeModal);
        vtModal.addEventListener('click', (e) => { if(e.target === vtModal) closeModal(); });

        // --- UI Update & Analysis Functions ---
        const updateUI = (data) => {
            verdictBanner.innerHTML = data.verdict === 'spam' ? `<div class="p-4 rounded-lg text-center text-white font-bold text-xl bg-red-500">Verdict: SPAM</div>` : `<div class="p-4 rounded-lg text-center text-white font-bold text-xl bg-green-500">Verdict: HAM</div>`;
            pipelineStages.innerHTML = data.stages.map(s => {
                const icons = {'passed': '‚úÖ', 'failed': 'üõë', 'skipped': '‚è©'};
                return `<div class="stage-card p-4 rounded-lg flex items-center space-x-4 stage-${s.status}"><div class="status-icon">${icons[s.status]}</div><div><h3 class="font-bold text-lg">${s.stage} Analysis</h3><p class="text-gray-600">${s.reason}</p></div></div>`;
            }).join('');
            
            linksSection.classList.toggle('hidden', !data.links?.length);
            linksList.innerHTML = (data.links || []).map(link => `<li class="extracted-item flex items-center justify-between bg-gray-50 p-2 rounded-md"><span>${link}</span><button class="vt-scan-btn" data-url="${link}">Scan</button></li>`).join('');

            attachmentsSection.classList.toggle('hidden', !data.attachments?.length);
            attachmentsList.innerHTML = (data.attachments || []).map(attachment => {
                const btn = originalFileObject ? `<button class="vt-scan-btn" data-filename="${attachment}">Scan</button>` : `<span class="text-xs text-gray-400">Scan N/A</span>`;
                return `<li class="extracted-item flex items-center justify-between bg-gray-50 p-2 rounded-md"><span>${attachment}</span>${btn}</li>`;
            }).join('');
        };

        analyzeBtn.addEventListener('click', async () => {
            const text = emailContent.value, file = originalFileObject;
            if (!text.trim() && !file) return alert('Please provide input.');
            analyzeBtn.disabled = true; analyzeBtn.textContent = 'Analyzing...';
            resultsContainer.classList.remove('hidden');
            
            const endpoint = file ? '/analyze_file' : '/analyze_text';
            let body, headers = {};
            if (file) { const fd = new FormData(); fd.append('eml_file', file); body = fd; }
            else { body = JSON.stringify({ email_text: text }); headers = { 'Content-Type': 'application/json' }; }
            
            try {
                const res = await fetch(endpoint, { method: 'POST', headers, body });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Server error');
                updateUI(data);
            } catch (error) {
                verdictBanner.innerHTML = `<div class="p-4 rounded-lg text-center text-white font-bold text-xl bg-gray-500">Error: ${error.message}</div>`;
            } finally {
                analyzeBtn.disabled = false; analyzeBtn.textContent = 'Analyze';
            }
        });
        
        const displayVTResults = (data, itemIdentifier) => {
            const stats = data.data?.attributes?.stats || {};
            const isFileScan = !!data.meta?.file_info;
            const sha256 = isFileScan ? data.meta.file_info.sha256 : null;
            let reportUrl = '#';

            if (isFileScan) {
                reportUrl = `https://www.virustotal.com/gui/file/${sha256}`;
            } else if (data.data?.links?.item) {
                // --- THIS IS THE FIX ---
                const urlId = data.data.links.item.split('/').pop();
                reportUrl = `https://www.virustotal.com/gui/url/${urlId}`;
            }

            vtModalContent.innerHTML = `
                <p class="mb-2"><strong>Item:</strong> <span class="font-mono text-xs">${itemIdentifier.slice(0, 47)}...</span></p>
                ${isFileScan ? `<p class="mb-2"><strong>SHA256:</strong> <span class="font-mono text-xs">${sha256}</span></p>` : ''}
                <div class="grid grid-cols-2 gap-2 text-center">
                    <div class="p-2 bg-red-100 rounded"><strong>Malicious:</strong> ${stats.malicious || 0}</div>
                    <div class="p-2 bg-yellow-100 rounded"><strong>Suspicious:</strong> ${stats.suspicious || 0}</div>
                    <div class="p-2 bg-gray-100 rounded"><strong>Undetected:</strong> ${stats.undetected || 0}</div>
                    <div class="p-2 bg-green-100 rounded"><strong>Harmless:</strong> ${stats.harmless || 0}</div>
                </div>
                <a href="${reportUrl}" target="_blank" class="block text-center mt-4 text-blue-600 hover:underline">View Full Report</a>`;
        };
        
        const pollForResult = async (analysisId, itemIdentifier, retries = 10) => {
            if (retries <= 0) { vtModalContent.innerHTML = `<p class="text-red-600 font-bold">Error: Scan timed out.</p>`; return; }
            try {
                const res = await fetch(`/get_vt_report/${analysisId}`);
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to get report.');
                
                if (data.data.attributes.status === 'completed') {
                    displayVTResults(data, itemIdentifier);
                } else {
                    vtModalContent.innerHTML = `<p class="text-center">Scan status: <strong>${data.data.attributes.status}</strong>. Checking again in 4 seconds...</p>`;
                    setTimeout(() => pollForResult(analysisId, itemIdentifier, retries - 1), 4000);
                }
            } catch(error) { vtModalContent.innerHTML = `<p class="text-red-600 font-bold">Error: ${error.message}</p>`; }
        };

        resultsContainer.addEventListener('click', async (e) => {
            if (!e.target.classList.contains('vt-scan-btn')) return;
            const btn = e.target;
            btn.disabled = true; btn.textContent = '...';
            openModal();
            vtModalContent.innerHTML = '<p class="text-center">Submitting to VirusTotal...</p>';
            let analysisId, itemIdentifier;

            try {
                let res, data;
                if (btn.dataset.url) { // URL Scan
                    itemIdentifier = btn.dataset.url;
                    res = await fetch('/scan_url', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: itemIdentifier }) });
                } else if (btn.dataset.filename && originalFileObject) { // File Scan
                    itemIdentifier = btn.dataset.filename;
                    const fd = new FormData();
                    fd.append('file', originalFileObject);
                    res = await fetch('/scan_attachment', { method: 'POST', body: fd });
                }
                
                if (!res) throw new Error("Invalid scan type.");
                data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Submission failed.');
                
                analysisId = data.data.id;
                if (analysisId) {
                    await pollForResult(analysisId, itemIdentifier);
                } else {
                    throw new Error("Could not get a valid analysis ID.");
                }
            } catch (error) {
                vtModalContent.innerHTML = `<p class="text-red-600 font-bold">Error: ${error.message}</p>`;
            } finally {
                btn.disabled = false; btn.textContent = 'Scan';
            }
        });
    });
    </script>
</body>
</html>

